<!doctype html>
<html>

<head>
  <title>TaggIt</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="vendors/jquery/jquery-2.1.0.js"></script>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <!-- Bootstrap material design -->
  <!-- https://cdn.rawgit.com/FezVrasta/bootstrap-material-design/gh-pages-v3/bootstrap-elements.html -->
  <!-- Material Design fonts -->
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/icon?family=Material+Icons">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.10/css/bootstrap-material-design.min.css" integrity="sha256-j3CLSRG31GkOu6kaeLh7XsRgL2YNvRl9aOtXoAYt320=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.10/css/ripples.min.css" integrity="sha256-+Og2qJI9qzvKYwhGo/LYXg0FzE1BhEQfDsUSjKXQ3Bg=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.10/js/material.min.js" integrity="sha256-uZbIqasulk7Y9yEwknbeQ0FpF3aUhtPwuggbpvQaI8Y=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.10/js/ripples.min.js" integrity="sha256-TY/EO/++Ug/P+fSBjaqlmtuphCBKwlP7TOnS+SGnN8g=" crossorigin="anonymous"></script>

  <!-- Leaflet (http://leafletjs.com/) -->
  <link rel="stylesheet" href="vendors/leaflet/leaflet.css" />
  <script src="vendors/leaflet/leaflet.js"></script>

  <!-- Leaflet pulsating icon (https://github.com/mapshakers/leaflet-icon-pulse) -->
  <link rel="stylesheet" href="vendors/LeafletPulsingIcon/L.Icon.Pulse.min.css" />
  <script src="vendors/LeafletPulsingIcon/L.Icon.Pulse.min.js"></script>

  <!-- Knockout.js -->
  <!--
        Try out knockout ==> Binding for Leaflet: https://github.com/giabos/ko-leaflet/blob/master/ko-leaflet.js
        Maybe needed for Bootstrap as well: https://faulknercs.github.io/Knockstrap/
     -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js" integrity="sha256-owX7sroiO/O1a7h3a4X29A1g3QgqdNvijRQ7V5TH45M=" crossorigin="anonymous"></script>
  <script src="resources/js/ko-leaflet.js"></script>
  <script src="https://cdn.rawgit.com/faulknercs/Knockstrap/v1.3.2/build/knockstrap.min.js" type="tet/javascript"></script>

  <!-- Application code -->
  <script src="resources/js/GeoLocation.js"></script>
  <script src="resources/js/TripRepository.js"></script>

  <link rel="stylesheet" href="resources/css/page-map.css" />
  <link rel="stylesheet" href="resources/css/sidebar.css" />
  <link rel="stylesheet" href="resources/css/glyphicon-util.css" />

</head>

<body>
  <div class="page has-sidebar" data-bind="css : { toggled : sidebarController.isVisible() }">
    <div class="sidebar-wrapper">
      <ul class="sidebar-nav">
        <li class="sidebar-brand">
          <a href="#">Start Bootstrap</a>
        </li>
        <li>
          <a href="#">Dashboard</a>
        </li>
        <li>
          <a href="#">Shortcuts</a>
        </li>
        <li>
          <a href="#">Overview</a>
        </li>
        <li>
          <a href="#">Events</a>
        </li>
        <li>
          <a href="#">About</a>
        </li>
        <li>
          <a href="#">Services</a>
        </li>
        <li>
          <a href="#">Contact</a>
        </li>
      </ul>
    </div>
    <div class="overlay" data-bind="visible: sidebarController.isVisible, click: sidebarController.close"></div>

    <div class="page-content-wrapper">
      <div id="header">
        <div class="row">
          <div class="col-xs-2 col-sm-1">
            <span id="toggleButton" class="glyphicon glyphicon-menu-hamburger btn btn-default gi-1_5x material-input" style="z-index:3000" data-bind="click: sidebarController.toggle"></span>
          </div>
          <!-- ko if:  mapController.filterbarVisible -->
          <div class="col-xs-7 col-sm-8" style="z-index:60;padding-right:0px">
            <input type="text" class="form-control" placeholder="Search..." />
          </div>
          <div class="col-xs-3 col-sm-3" style="z-index:60;padding-left:0px">
            <span class="glyphicon glyphicon-search navbar-btn btn btn-default gi-1_5x material-input" style="padding-right: 15px;"></span>

            <span class="glyphicon glyphicon-filter navbar-btn btn btn-default gi-1_5x material-input"></span>
          </div>
          <!-- /ko -->
        </div>
      </div>

      <div id="btn-center-map" class="btn-group" data-bind="visible: mapController.buttonsVisible, click: mapController.centerMapHandler">
        <a class="btn btn-primary btn-fab btn-raised">
          <i class="material-icons">adjust</i>
        </a>
      </div>
      <div id="btn-add-location" class="btn-group" data-bind="visible: mapController.buttonsVisible, click: mapController.addMarkerHandler">
        <a class="btn btn-primary btn-fab btn-raised">
          <i class="material-icons">pin_drop</i>
        </a>
      </div>
      <div data-bind="leafletMap: mapController, visible: mapController.mapVisible" class="map"></div>

      <p id="message" data-bind="text: messageContent"></p>
    </div>

  </div>
  <script>
    var controller;

    var sidebarController = {
      isVisible: ko.observable(false),
      toggle: function() {
        sidebarController.isVisible(!sidebarController.isVisible());
      },
      close: function(e) {
        sidebarController.isVisible(false);
      }
    };

    var messageContent = ko.observable();

    (function($) {
      $.material.init()

      function getRandomArbitrary(min, max) {
        return Math.random() * (max - min) + min;
      }

      var watchId;

      var mapController = {
        center: [ko.observable(50.81057), ko.observable(4.93622)],
        zoom: ko.observable(16),
        markers: ko.observableArray([]),
        mapOptions: {
          zoomControl: false
        },
        events: {
          dragstart: function(evt) {
            console.log("DISABLE watch")
            if (watchId > 0) {
              GeoLocation.clearWatch(watchId);
              watchId = -1;
            }
          }
        },
        centerMarker: {
          center: [ko.observable(50.81057), ko.observable(4.93622)],
          draggable: false,
          icon: L.icon.pulse({
            iconSize: [18, 18],
            color: '#2196F3'
          })
        },
        centerCircle: {
          fillColor: '#2196F3',
          radius: ko.observable(0)
        },
        mapVisible: ko.observable(false),
        buttonsVisible: ko.observable(false),
        filterbarVisible: ko.observable(false),
        bounds: ko.observable(),
        addMarkerHandler: function() {
          var bounds = mapController.bounds();
          if (!!bounds) {
            //TODO create marker at map center location
            var lat = getRandomArbitrary(bounds._northEast.lat, bounds._southWest.lat)
            var lng = getRandomArbitrary(bounds._southWest.lng, bounds._northEast.lng)

            mapController.addMarker([lat, lng])
          }
        },
        centerMapHandler: function() {
          if (watchId > 0) {
            GeoLocation.clearWatch(watchId);
            watchId = -1;
          }
          watchId = GeoLocation.watch(updateMyLocationMarker, updateLocationGpsError);
        },

        addMarker: function(position) {
          this.markers.push({
            center: [ko.observable(position[0]), ko.observable(position[1])],
            draggable: true,
            opened: ko.observable(false)
          });
        },

        removeMarker: function(i) {
          this.markers.splice(i, 1);
        },

        updateCenter: function(arguments) {
          arguments = arguments || {}
          this.center[0](arguments.lat);
          this.center[1](arguments.lng);
          if (!!arguments.zoom) {
            this.zoom(arguments.zoom);
          }
          this.centerMarker.center[0](arguments.lat);
          this.centerMarker.center[1](arguments.lng);
          this.centerCircle.radius((arguments.accuracy || 0) * 2)
        }
      }

      function updateMyLocationMarker(position) {
        var accuracy = position.coords.accuracy;
        var centerOptions = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          accuracy: (accuracy > 100 && accuracy < 400) ? accuracy : 0
        };
        mapController.updateCenter(centerOptions)

        mapController.buttonsVisible(true)
        mapController.mapVisible(true)
        mapController.filterbarVisible(true)
      }

      function updateLocationGpsError(error) {
        GeoLocation.printError(error)
        mapController.buttonsVisible(false)
        mapController.mapVisible(false)
        mapController.filterbarVisible(false)
        messageContent("GPS error: Could not retrieve location")
      }

      function initLocationGpsError(error) {
        console.log("initLocationGpsError")
        GeoLocation.printError(error)
        messageContent("GPS error: Initialization error; is the GPS enabled?")
      }

      function initMap() {
        GeoLocation.get().then(function(position) {
          var pos = [position.coords.latitude, position.coords.longitude];
          var accuracy = position.coords.accuracy;
          console.log("Got actual position")
          //TODO add spinner that indicates loading and hide it when this method has finished.
          var centerOptions = {
            lat: pos[0],
            lng: pos[1],
            zoom: 16,
            accuracy: (accuracy > 100 && accuracy < 400) ? accuracy : 0
          };
          mapController.updateCenter(centerOptions)
          mapController.buttonsVisible(true)
          mapController.mapVisible(true)
          mapController.filterbarVisible(true)
          watchId = GeoLocation.watch(updateMyLocationMarker, updateLocationGpsError);
        }).catch(function(error) {
          initLocationGpsError(error);
          window.setTimeout(initMap, 1000)
        })
      }

      initMap();

      controller = {
        mapController: mapController,
        sidebarController: sidebarController,
        messageContent: messageContent
      };

      ko.applyBindings(controller);

      console.log("All done loading")

    })(jQuery);
  </script>
</body>

</html>
